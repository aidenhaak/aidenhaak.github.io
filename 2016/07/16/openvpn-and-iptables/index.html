<!doctype html><html lang=en>
<head>
<meta name=description content="I recently setup an OpenVPN server, I mostly followed the fantastic Digital Ocean (DO) guide, however I ended up using iptables instead of ufw. Since setting up my iptables configuration correctly was probably the one thing that gave me the most trouble I thought I'd share.">
<meta name=HandheldFriendly content="True">
<meta name=MobileOptimized content="320">
<meta name=viewport content="width=device-width,minimum-scale=1">
<meta charset=utf-8>
<title>Aiden Haak | OpenVPN and Iptables</title><link rel=preload href=../../../../fonts/ZillaSlab-SemiBold.ttf as=font crossorigin=anonymous>
<link rel=preload href=../../../../fonts/ZillaSlab-Bold.ttf as=font crossorigin=anonymous>
<link rel=preload href=../../../../fonts/FiraSans-Regular.ttf as=font crossorigin=anonymous>
<link rel=preload href=../../../../fonts/FiraSans-Italic.ttf as=font crossorigin=anonymous>
<link rel=preload href=../../../../fonts/FiraSans-BoldItalic.ttf as=font crossorigin=anonymous>
<link rel=preload href=../../../../fonts/FiraSans-Bold.ttf as=font crossorigin=anonymous>
<link rel=preload href=../../../../fonts/FiraMono-Regular.ttf as=font crossorigin=anonymous>
<link rel=stylesheet href=../../../../scss/main.min.2c4f01e1ed36dc6f7795b45043aa077420f08ffea1ca2c2d6a7c0637662c7fa1.css><meta property="og:title" content="OpenVPN and Iptables">
<meta property="og:description" content="I recently setup an OpenVPN server, I mostly followed the fantastic Digital Ocean (DO) guide, however I ended up using iptables instead of ufw. Since setting up my iptables configuration correctly was probably the one thing that gave me the most trouble I thought I'd share.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://www.aidenhaak.com/2016/07/16/openvpn-and-iptables/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2016-07-16T00:00:00+00:00">
<meta property="article:modified_time" content="2016-07-16T00:00:00+00:00">
<meta itemprop=name content="OpenVPN and Iptables">
<meta itemprop=description content="I recently setup an OpenVPN server, I mostly followed the fantastic Digital Ocean (DO) guide, however I ended up using iptables instead of ufw. Since setting up my iptables configuration correctly was probably the one thing that gave me the most trouble I thought I'd share."><meta itemprop=datePublished content="2016-07-16T00:00:00+00:00">
<meta itemprop=dateModified content="2016-07-16T00:00:00+00:00">
<meta itemprop=wordCount content="384">
<meta itemprop=keywords content><meta name=twitter:card content="summary">
<meta name=twitter:title content="OpenVPN and Iptables">
<meta name=twitter:description content="I recently setup an OpenVPN server, I mostly followed the fantastic Digital Ocean (DO) guide, however I ended up using iptables instead of ufw. Since setting up my iptables configuration correctly was probably the one thing that gave me the most trouble I thought I'd share.">
</head><body>
<div class=footer-wrapper>
<header>
<div class=container>
<h1 class=site-title>
<a href=../../../../>Aiden Haak</a>
</h1><nav>
<ul>
<li>
<a href=../../../../about title="About page">
About
</a>
</li></ul></nav><ul class=social>
<li>
<a href=https://twitter.com/aidenhaak title=Twitter><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M23.954 4.569c-.885.389-1.83.654-2.825.775 1.014-.611 1.794-1.574 2.163-2.723-.951.555-2.005.959-3.127 1.184-.896-.959-2.173-1.559-3.591-1.559-2.717.0-4.92 2.203-4.92 4.917.0.39.045.765.127 1.124C7.691 8.094 4.066 6.13 1.64 3.161c-.427.722-.666 1.561-.666 2.475.0 1.71.87 3.213 2.188 4.096-.807-.026-1.566-.248-2.228-.616v.061c0 2.385 1.693 4.374 3.946 4.827-.413.111-.849.171-1.296.171-.314.0-.615-.03-.916-.086.631 1.953 2.445 3.377 4.604 3.417-1.68 1.319-3.809 2.105-6.102 2.105-.39.0-.779-.023-1.17-.067 2.189 1.394 4.768 2.209 7.557 2.209 9.054.0 13.999-7.496 13.999-13.986.0-.209.0-.42-.015-.63.961-.689 1.8-1.56 2.46-2.548l-.047-.02z"/></svg>
</a>
</li><li>
<a href=https://github.com/aidenhaak/ title=GitHub><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 .297c-6.63.0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577.0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93.0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176.0.0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22.0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22.0 1.606-.015 2.896-.015 3.286.0.315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
</a>
</li><li>
<a href=../../../../index.xml title="Atom Feed"><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19.199 24C19.199 13.467 10.533 4.8.0 4.8V0c13.165.0 24 10.835 24 24h-4.801zM3.291 17.415c1.814.0 3.293 1.479 3.293 3.295.0 1.813-1.485 3.29-3.301 3.29C1.47 24 0 22.526.0 20.71s1.475-3.294 3.291-3.295zM15.909 24h-4.665c0-6.169-5.075-11.245-11.244-11.245V8.09c8.727.0 15.909 7.184 15.909 15.91z"/></svg>
</a>
</li></ul></div></header><div class="content container">
<main>
<article>
<h1 class=post-title>OpenVPN and Iptables</h1><span class=post-date>July 16, 2016</span>
<p>I recently setup an <a href=https://openvpn.net/>OpenVPN</a> server, I mostly followed the <a href=https://www.digitalocean.com/community/tutorials/how-to-set-up-an-openvpn-server-on-ubuntu-14-04>fantastic Digital Ocean (DO) guide</a>, however I ended up using <a href=https://en.wikipedia.org/wiki/Iptables>iptables</a> instead of <a href=https://help.ubuntu.com/community/UFW>ufw</a>. Since setting up my iptables configuration correctly was probably the one thing that gave me the most trouble I thought I&rsquo;d share.</p><p>I setup OpenVPN using a TUN adapter for my OpenVPN server because 1: that&rsquo;s what the DO guide does and 2: I don&rsquo;t plan to do any bridging. However, if you are using a TAP adapter you can read more about it on the <a href=https://community.openvpn.net/openvpn/wiki/BridgingAndRouting>OpenVPN website</a>.</p><p>The iptables rules file I ended up using looked something like the following.</p><pre tabindex=0><code class=language-kernel-config data-lang=kernel-config>*filter

# Allow all loopback (lo0) traffic and reject traffic
# to localhost that does not originate from lo0.
-A INPUT -i lo -j ACCEPT
-A INPUT ! -i lo -s 127.0.0.0/8 -j REJECT

# Allow ping.
-A INPUT -p icmp -m conntrack --ctstate NEW --icmp-type 8 -j ACCEPT

# Allow SSH connections.
-A INPUT -p tcp --dport 22 -m conntrack --ctstate NEW -j ACCEPT

# Allow OpenVPN connections.
-A INPUT -p udp --dport 1194 -m conntrack --ctstate NEW -j ACCEPT

# Allow inbound traffic from established connections.
# This includes ICMP error returns.
-A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

# Reject all other inbound.
-A INPUT -j REJECT

# Allow traffic initiated from VPN to access LAN.
-A FORWARD -i tun0 -o eth0 -s 10.8.0.0/24 -d 10.0.0.4/24 -m conntrack --ctstate NEW -j ACCEPT

# Allow established traffic to pass back and forth.
-A FORWARD -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT

# Drop invalid packets.
-A INPUT -m conntrack --ctstate INVALID -j DROP

COMMIT

*nat

# Masquerade all traffic from VPN clients.
-A POSTROUTING -o eth0 -s 10.8.0.0/24 -j MASQUERADE

COMMIT</code></pre><p>There&rsquo;s a few basic non-OpenVPN related items in there - e.g. allow SSH, ping, but overall it&rsquo;s a pretty barebones iptables configuration since I plan to just run OpenVPN on this server. Also note that this only for IPv4 traffic and NOT IPv6.</p><p>Finally, to load the rules so that your server is using them it&rsquo;s a matter of running a simple one line command.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo iptables-restore openvpniptable.rules</span></span></code></pre></div><p>And that&rsquo;s it! Assuming you followed the rest of the DO guide you should now have a shiny new OpenVPN server using iptables up and running. Happy VPNing.</p></article><div class=post-comments>
<div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//aidenhaak.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</div></main><div class=footer-push></div></div></div><footer>
<div class=container>
<p class=copyright>© 2013-2022 Aiden Haak – Powered by <a href=https://gohugo.io/>Hugo</a></p></div></footer></body></html>