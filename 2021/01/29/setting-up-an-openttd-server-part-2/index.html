<!doctype html><html lang=en>
<head>
<meta name=description content="I found myself wanting to scratch my OpenTTD itch again but I need to setup another server">
<meta name=HandheldFriendly content="True">
<meta name=MobileOptimized content="320">
<meta name=viewport content="width=device-width,minimum-scale=1">
<meta charset=utf-8>
<title>Aiden Haak | Setting Up An OpenTTD Server Part 2</title><link rel=preload href=../../../../fonts/ZillaSlab-SemiBold.ttf as=font crossorigin=anonymous>
<link rel=preload href=../../../../fonts/ZillaSlab-Bold.ttf as=font crossorigin=anonymous>
<link rel=preload href=../../../../fonts/FiraSans-Regular.ttf as=font crossorigin=anonymous>
<link rel=preload href=../../../../fonts/FiraSans-Italic.ttf as=font crossorigin=anonymous>
<link rel=preload href=../../../../fonts/FiraSans-BoldItalic.ttf as=font crossorigin=anonymous>
<link rel=preload href=../../../../fonts/FiraSans-Bold.ttf as=font crossorigin=anonymous>
<link rel=preload href=../../../../fonts/FiraMono-Regular.ttf as=font crossorigin=anonymous>
<link rel=stylesheet href=../../../../scss/main.min.2c4f01e1ed36dc6f7795b45043aa077420f08ffea1ca2c2d6a7c0637662c7fa1.css><meta property="og:title" content="Setting Up An OpenTTD Server Part 2">
<meta property="og:description" content="I found myself wanting to scratch my OpenTTD itch again but I need to setup another server">
<meta property="og:type" content="article">
<meta property="og:url" content="https://www.aidenhaak.com/2021/01/29/setting-up-an-openttd-server-part-2/"><meta property="og:image" content="https://www.aidenhaak.com/images/new-grf-settings.png"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-01-29T00:00:00+00:00">
<meta property="article:modified_time" content="2021-01-29T00:00:00+00:00">
<meta itemprop=name content="Setting Up An OpenTTD Server Part 2">
<meta itemprop=description content="I found myself wanting to scratch my OpenTTD itch again but I need to setup another server"><meta itemprop=datePublished content="2021-01-29T00:00:00+00:00">
<meta itemprop=dateModified content="2021-01-29T00:00:00+00:00">
<meta itemprop=wordCount content="899"><meta itemprop=image content="https://www.aidenhaak.com/images/new-grf-settings.png">
<meta itemprop=keywords content><meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://www.aidenhaak.com/images/new-grf-settings.png">
<meta name=twitter:title content="Setting Up An OpenTTD Server Part 2">
<meta name=twitter:description content="I found myself wanting to scratch my OpenTTD itch again but I need to setup another server">
</head><body>
<div class=footer-wrapper>
<header>
<div class=container>
<h1 class=site-title>
<a href=../../../../>Aiden Haak</a>
</h1><nav>
<ul>
<li>
<a href=../../../../about title="About page">
About
</a>
</li></ul></nav><ul class=social>
<li>
<a href=https://twitter.com/aidenhaak title=Twitter><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M23.954 4.569c-.885.389-1.83.654-2.825.775 1.014-.611 1.794-1.574 2.163-2.723-.951.555-2.005.959-3.127 1.184-.896-.959-2.173-1.559-3.591-1.559-2.717.0-4.92 2.203-4.92 4.917.0.39.045.765.127 1.124C7.691 8.094 4.066 6.13 1.64 3.161c-.427.722-.666 1.561-.666 2.475.0 1.71.87 3.213 2.188 4.096-.807-.026-1.566-.248-2.228-.616v.061c0 2.385 1.693 4.374 3.946 4.827-.413.111-.849.171-1.296.171-.314.0-.615-.03-.916-.086.631 1.953 2.445 3.377 4.604 3.417-1.68 1.319-3.809 2.105-6.102 2.105-.39.0-.779-.023-1.17-.067 2.189 1.394 4.768 2.209 7.557 2.209 9.054.0 13.999-7.496 13.999-13.986.0-.209.0-.42-.015-.63.961-.689 1.8-1.56 2.46-2.548l-.047-.02z"/></svg>
</a>
</li><li>
<a href=https://github.com/aidenhaak/ title=GitHub><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 .297c-6.63.0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577.0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93.0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176.0.0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22.0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22.0 1.606-.015 2.896-.015 3.286.0.315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
</a>
</li><li>
<a href=../../../../index.xml title="Atom Feed"><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19.199 24C19.199 13.467 10.533 4.8.0 4.8V0c13.165.0 24 10.835 24 24h-4.801zM3.291 17.415c1.814.0 3.293 1.479 3.293 3.295.0 1.813-1.485 3.29-3.301 3.29C1.47 24 0 22.526.0 20.71s1.475-3.294 3.291-3.295zM15.909 24h-4.665c0-6.169-5.075-11.245-11.244-11.245V8.09c8.727.0 15.909 7.184 15.909 15.91z"/></svg>
</a>
</li></ul></div></header><div class="content container">
<main aria-role=main>
<article>
<h1 class=post-title>Setting Up An OpenTTD Server Part 2</h1><span class=post-date>January 29, 2021</span>
<p>I found myself wanting to scratch my OpenTTD itch again but I need to setup another server as I had long ago nuked the server for <a href=https://www.aidenhaak.com/2015/11/08/setting-up-an-openttd-server/>part one</a>. Turns out that part one is (unsurprisngly) a bit out of date after five years and this time I wanted to dabble in some custom graphics or GRFs for my server.</p><p>For the first problem there is a an easy fix thanks to an <a href=https://hub.docker.com/r/bateau/openttd>OpenTTD docker image</a>. As for the custom GRFs - well you&rsquo;ll just have to keep reading.</p><p>For this guide I&rsquo;m assuming:</p><ul>
<li>That you&rsquo;re running OpenTTD locally on a Windows desktop.</li><li>You have a Google Cloud account setup and you know your way around it a bit.</li><li>The OpenTTD server will run on Ubuntu.</li></ul><h2 id=customising-the-custom-graphics>Customising the Custom Graphics</h2><p>I found the easiest way to get the graphics files setup was to do it in game via the New GRF settings</p><p>Once you are happy with your custom GRFs (making sure that they are compatible with each other!) it&rsquo;s time fire up the command prompt and run OpenTTD as a local server using the following command:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-batch data-lang=batch><span style=display:flex><span>openttd.exe -D</span></span></code></pre></div><p>This will make OpenTTD generate the config file and GRF files that our server can use. After a brief wait you can stop the OpenTTD server after it has finished generating the map and has started the game.</p><p>Next navigate to <code>C:\Users\&lt;username>\Documents\OpenTTD</code> where you should see a <code>openttd.cfg</code> file and a <code>content_download</code> folder. These are the files we will be uploading to a storage bucket. It is a good idea to double check that the new GRFs are correctly included in the config file, you should see something like the following at the end of the <code>openttd.cfg</code> file:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cfg data-lang=cfg><span style=display:flex><span><span style=color:#00a8c8>[newgrf]</span>
</span></span><span style=display:flex><span><span style=color:#75af00>44440111|9B505....AFB0CA|uk_renewal_set.3.04\pb_ukrs.grf</span> <span style=color:#f92672>=</span> 
</span></span><span style=display:flex><span><span style=color:#75af00>F1250007|997B3....46D7EB|firs_industry_replacement_set_3-3.0.12\firs.grf</span> <span style=color:#f92672>=</span> <span style=color:#d88200>0 0 0 0 0 0 16 150 80 300</span>
</span></span><span style=display:flex><span><span style=color:#75af00>4A530117|CA321....D4A501|ecs__firs_vehicle_set-2014.11.26\efrefit.grf</span> <span style=color:#f92672>=</span> </span></span></code></pre></div><h2 id=google-cloud-setup>Google Cloud Setup</h2><p>We will be running OpenTTD on the <a href=https://cloud.google.com/free>free F1-micro instance</a> but first we have a few things to setup.</p><h3 id=storage>Storage</h3><p>Firstly create a new <a href=https://cloud.google.com/storage>Storage bucket</a> for your OpenTTD files then upload the <code>openttd.cfg</code> file and <code>content_download</code> folder from the <code>C:\Users\&lt;username>\Documents\OpenTTD</code> folder to a <code>openttd</code> folder in the bucket. Remember to edit the <code>openttd.cfg</code> file to your desired settings before uploading as this is the configuration your server will be using.</p><p>After the upload has finished the folder in your bucket should look like the following.</p><h3 id=firewall>Firewall</h3><p>We need to add a <a href=https://console.cloud.google.com/networking/firewalls/>firewall rule</a> to the <a href=https://cloud.google.com/vpc/docs/vpc>VPC network</a> the server will be running in to allow the OpenTTD traffic through. Create a firewall rule that allows TCP and UDP on your desired OpenTTD port &ndash; by default this is port 3979.</p><h3 id=putting-it-all-together>Putting It All Together</h3><p>Now it&rsquo;s time to create a new VM instance but there are a few settings that need to be configured. Firstly, make sure to use a Ubuntu image and then assign a public IP to your instance to ensure that it is reachable over the public internet.</p><p>Then copy the following bash script <em>after</em> changing the <code>OPENTTD_BUCKET_NAME</code> in the script to the same name as the bucket you created earlier in this guide.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#f92672>[</span> <span style=color:#d88200>&#34;</span><span style=color:#111>$EUID</span><span style=color:#d88200>&#34;</span> -ne <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>then</span> <span style=color:#111>echo</span> <span style=color:#d88200>&#34;Please run as root&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#111>exit</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Use the same bucket name from earlier in the guide here.</span>
</span></span><span style=display:flex><span><span style=color:#111>OPENTTD_BUCKET_NAME</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;bucketname&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Install some prerequisites.</span>
</span></span><span style=display:flex><span>apt-get update -y
</span></span><span style=display:flex><span>apt-get install -y <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>    apt-transport-https <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>    ca-certificates <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>    curl <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>    gnupg-agent <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>    software-properties-common
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Next steps copy pasted from: https://docs.docker.com/engine/install/ubuntu/</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Add Docker’s official GPG key</span>
</span></span><span style=display:flex><span>curl -fsSL https://download.docker.com/linux/ubuntu/gpg <span style=color:#111>|</span> apt-key add -
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Add the Docker repository.</span>
</span></span><span style=display:flex><span>add-apt-repository <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>   <span style=color:#d88200>&#34;deb [arch=amd64] https://download.docker.com/linux/ubuntu \
</span></span></span><span style=display:flex><span><span style=color:#d88200>   </span><span style=color:#00a8c8>$(</span>lsb_release -cs<span style=color:#00a8c8>)</span><span style=color:#d88200> \
</span></span></span><span style=display:flex><span><span style=color:#d88200>   stable&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Install docker</span>
</span></span><span style=display:flex><span>apt-get update -y
</span></span><span style=display:flex><span>apt-get install docker-ce docker-ce-cli -y
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Add the openttd group and user.</span>
</span></span><span style=display:flex><span>groupadd openttd -r
</span></span><span style=display:flex><span>useradd openttd -r -g openttd,docker
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>OPENTTD_GROUP_ID</span><span style=color:#f92672>=</span><span style=color:#d88200>`</span>id -g openttd<span style=color:#d88200>`</span>
</span></span><span style=display:flex><span><span style=color:#111>OPENTTD_USER_ID</span><span style=color:#f92672>=</span><span style=color:#d88200>`</span>id -u openttd<span style=color:#d88200>`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Add firewall exceptions.</span>
</span></span><span style=display:flex><span>apt install ufw -y
</span></span><span style=display:flex><span>ufw allow <span style=color:#ae81ff>3979</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>OPENTTD_DIR</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;/etc/openttd&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Download the openttd config file and GRFs.</span>
</span></span><span style=display:flex><span>mkdir -p <span style=color:#111>$OPENTTD_DIR</span>
</span></span><span style=display:flex><span>gsutil cp -r <span style=color:#d88200>&#34;gs://</span><span style=color:#111>$OPENTTD_BUCKET_NAME</span><span style=color:#d88200>/openttd&#34;</span> <span style=color:#111>$OPENTTD_DIR</span>
</span></span><span style=display:flex><span>chown openttd:openttd -R <span style=color:#111>$OPENTTD_DIR</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Finally run the container.</span>
</span></span><span style=display:flex><span>docker run --name openttd -d <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>    -e <span style=color:#111>PUID</span><span style=color:#f92672>=</span><span style=color:#111>$OPENTTD_USER_ID</span> <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>    -e <span style=color:#111>PGID</span><span style=color:#f92672>=</span><span style=color:#111>$OPENTTD_GROUP_ID</span> <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>    -v <span style=color:#111>$OPENTTD_DIR</span>:/home/openttd/.openttd <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>    -p 3979:3979/tcp <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>    -p 3979:3979/udp <span style=color:#8045ff>\
</span></span></span><span style=display:flex><span><span style=color:#8045ff></span>    bateau/openttd:latest</span></span></code></pre></div><p>And paste it into the start-up script section for the VM.</p><p>Now create the instance and sit back and wait for the magic to happen 🧙‍♂️</p><p>Add the server IP via the in-game browser and you should be able to join!</p><h2 id=troubleshooting>Troubleshooting</h2><p>If you can&rsquo;t connect to your OpenTTD server here are a few basic steps you can try. Firstly, make sure you can ping the server via its public IP. Secondly, verify that the docker container is actually running on the server.</p><p>You can do this by running <code>docker ps -a</code> and you should see an <code>bateau/openttd</code> image in the results. If it&rsquo;s not there it&rsquo;s likely the startup script failed to run and you can try running the script manually. One easy way to do this is to upload the initialization script to the openttd bucket and run the following commands:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gsutil cp <span style=color:#d88200>&#34;gs://OPENTTD_BUCKET_NAME/init.sh&#34;</span>
</span></span><span style=display:flex><span>chmod +x init.sh
</span></span><span style=display:flex><span>sudo ./init.sh</span></span></code></pre></div><p>After the script has run check the docker container is running &ndash; if OpenTTD still isn&rsquo;t running after this the problem is left as <a href=https://abstrusegoose.com/395>an exercise for reader</a>.</p><h2 id=next-steps>Next Steps</h2><p>Some next steps to consider for your server:</p><ul>
<li>Add a domain for your server.</li><li>Add cron job to upload save games to storage bucket so you can relive your greatest maps!</li></ul></article><div class=post-comments>
<div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//aidenhaak.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</div></main><div class=footer-push></div></div></div><footer>
<div class=container>
<p class=copyright>© 2013-2022 Aiden Haak – Powered by <a href=https://gohugo.io/>Hugo</a></p></div></footer></body></html>